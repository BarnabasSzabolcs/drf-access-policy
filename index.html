



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>Dango REST - Access Policy</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/application.30686662.css">
      
        <link rel="stylesheet" href="assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
      <script src="assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="black" data-md-color-accent="red">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#django-rest-access-policy" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="." title="Dango REST - Access Policy" class="md-header-nav__button md-logo">
          
            <i class="md-icon">security</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Dango REST - Access Policy
            </span>
            <span class="md-header-nav__topic">
              
                Django REST - Access Policy
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/rsinger86/drf-access-policy/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    rsinger86/drf-access-policy
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="." title="Dango REST - Access Policy" class="md-nav__button md-logo">
      
        <i class="md-icon">security</i>
      
    </a>
    Dango REST - Access Policy
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/rsinger86/drf-access-policy/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    rsinger86/drf-access-policy
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
    <a href="." title="Django REST - Access Policy" class="md-nav__link md-nav__link--active">
      Django REST - Access Policy
    </a>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/rsinger86/drf-access-policy/edit/master/docs/index.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="django-rest-access-policy">Django REST - Access Policy<a class="headerlink" href="#django-rest-access-policy" title="Permanent link">&para;</a></h1>
<p><a href="https://pypi.python.org/pypi/drf-access-policy"><img alt="Package version" src="https://badge.fury.io/py/drf-access-policy.svg" /></a>
<a href="https://img.shields.io/pypi/status/drf-access-policy.svg/"><img alt="Python versions" src="https://img.shields.io/pypi/status/drf-access-policy.svg" /></a></p>
<p>This project brings a declaritive, organized approach to managing access control in Django REST Framework projects. Each ViewSet or function-based view can be assigned an explicit policy for the exposed resource(s). No more digging through views or seralizers to understand access logic -- it's all in one place in a format that less technical stakeholders can understand. If you're familiar with other declaritive access models, such as AWS' IAM, the syntax will be familiar. </p>
<p>In short, you can start expressing your access rules like this:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ArticleAccessPolicy</span><span class="p">(</span><span class="n">AccessPolicy</span><span class="p">):</span>
    <span class="n">statements</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="s2">&quot;retrieve&quot;</span><span class="p">],</span>
            <span class="s2">&quot;principal&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
            <span class="s2">&quot;effect&quot;</span><span class="p">:</span> <span class="s2">&quot;allow&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;publish&quot;</span><span class="p">,</span> <span class="s2">&quot;unpublish&quot;</span><span class="p">],</span>
            <span class="s2">&quot;principal&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;group:editor&quot;</span><span class="p">],</span>
            <span class="s2">&quot;effect&quot;</span><span class="p">:</span> <span class="s2">&quot;allow&quot;</span>            
        <span class="p">}</span>
    <span class="p">]</span>
</pre></div>


<p>This project has complete test coverage and the base <code>AccessPolicy</code> class is only ~150 lines of code: there's no magic here.</p>
<h1 id="table-of-contents">Table of Contents:<a class="headerlink" href="#table-of-contents" title="Permanent link">&para;</a></h1>
<ul>
<li><a href="#installation">Installation</a></li>
<li><a href="#example-1-policy-for-viewset">Example #1: Policy for ViewSet</a></li>
<li><a href="#example-2-policy-for-function-based-view">Example #2: Policy for Function-Based View</a></li>
<li><a href="#documentation">Documentation</a></li>
<li><a href="#statement-elements">Statement Elements</a><ul>
<li><a href="#principal">principal</a></li>
<li><a href="#action">action</a></li>
<li><a href="#effect">effect</a></li>
<li><a href="#condition">condition</a></li>
</ul>
</li>
<li><a href="#policy-evaluation-logic">Policy Evaluation Logic</a></li>
<li><a href="#object-level-perm">Object-Level Permissions/Conditions</a></li>
<li><a href="#reusable-conditions">Re-Usable Conditions/Permissions</a></li>
<li><a href="#multitenancy-data--restricting-querysets">Multitenancy Data/Restricting QuerySets</a></li>
<li><a href="#attaching-to-viewsets-and-function-based-views">Attaching to ViewSets and Function-Based Views</a></li>
<li><a href="#loading-statements-from-external-source">Loading Statements from External Source</a></li>
<li><a href="#customizing-user-grouprole-values">Customizing User Group/Role Values</a></li>
<li><a href="#customizing-principal-prefixes">Customizing Principal Prefixes</a></li>
<li><a href="#changelog">Changelog</a></li>
<li><a href="#testing">Testing</a></li>
<li><a href="#license">License</a></li>
</ul>
<h1 id="setup">Setup<a class="headerlink" href="#setup" title="Permanent link">&para;</a></h1>
<div class="codehilite"><pre><span></span>pip install drf-access-policy
</pre></div>


<p>To define a policy, import <code>AccessPolicy</code> and subclass it:</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">rest_access_policy</span> <span class="kn">import</span> <span class="n">AccessPolicy</span>


<span class="k">class</span> <span class="nc">ShoppingCartAccessPolicy</span><span class="p">(</span><span class="n">AccessPolicy</span><span class="p">):</span>
    <span class="n">statements</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Now read on...</span>
</pre></div>


<h1 id="example-1-policy-for-viewset">Example #1: Policy for ViewSet<a class="headerlink" href="#example-1-policy-for-viewset" title="Permanent link">&para;</a></h1>
<p>In a nutshell, a policy is comprised of "statements" that declare what "actions" a "principal" can or cannot perform on the resource, with optional custom checks that can examine any detail of the current request.</p>
<p>Here are two more key points to remember going forward:
* all access is implicitly denied by default
* any statement with the "deny" effect overrides any and all "allow" statement</p>
<p>Now let's look at the policy below an articles endpoint, provided through a view set.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ArticleAccessPolicy</span><span class="p">(</span><span class="n">AccessPolicy</span><span class="p">):</span>
    <span class="n">statements</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="s2">&quot;retrieve&quot;</span><span class="p">],</span>
            <span class="s2">&quot;principal&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
            <span class="s2">&quot;effect&quot;</span><span class="p">:</span> <span class="s2">&quot;allow&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;publish&quot;</span><span class="p">,</span> <span class="s2">&quot;unpublish&quot;</span><span class="p">],</span>
            <span class="s2">&quot;principal&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;group:editor&quot;</span><span class="p">],</span>
            <span class="s2">&quot;effect&quot;</span><span class="p">:</span> <span class="s2">&quot;allow&quot;</span>            
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;delete&quot;</span><span class="p">],</span>
            <span class="s2">&quot;principal&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
            <span class="s2">&quot;effect&quot;</span><span class="p">:</span> <span class="s2">&quot;allow&quot;</span><span class="p">,</span>
            <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;is_author&quot;</span>         
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
            <span class="s2">&quot;principal&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
            <span class="s2">&quot;effect&quot;</span><span class="p">:</span> <span class="s2">&quot;deny&quot;</span><span class="p">,</span>
            <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;is_happy_hour&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">is_author</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">article</span><span class="o">.</span><span class="n">author</span> 

    <span class="k">def</span> <span class="nf">is_happy_hour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">now</span><span class="o">.</span><span class="n">hour</span> <span class="o">&gt;=</span> <span class="mi">17</span> <span class="ow">and</span> <span class="n">now</span><span class="o">.</span><span class="n">hour</span> <span class="o">&lt;=</span> <span class="mi">18</span><span class="p">:</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">scope_queryset</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;editor&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">queryset</span>

        <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;published&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ArticleViewSet</span><span class="p">(</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="c1"># Just stick the policy here, as you would do with</span>
    <span class="c1"># regular DRF &quot;permissions&quot;</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">ArticleAccessPolicy</span><span class="p">,</span> <span class="p">)</span>

    <span class="c1"># Helper property here to make get_queryset logic</span>
    <span class="c1"># more explicit</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">access_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">permission_classes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Ensure that current user can only see the models </span>
    <span class="c1"># they are allowed to see</span>
    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_policy</span><span class="o">.</span><span class="n">scope_queryset</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">Articles</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="nd">@action</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@action</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">unpublish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1"># the rest of you view set definition...</span>
</pre></div>


<p>The actions correspond to the names of methods on the ViewSet. </p>
<p>In the example above, the following rules are put in place:
- anyone is allowed to list and retrieve articles
- users in the editor group are allowed to publish and unpublish articles
- in order to delete an article, the user must be the author of the article. Notice how the condition method <code>is_author</code> calls <code>get_object()</code> on the view to get the current article.
- if the condition <code>is_happy_hour</code>, evaluates to <code>True</code>, then no one is allowed to do anything.</p>
<p>Additionally, we have some logic in the <code>scope_queryset</code> method for filtering which models are visible to the current user. Here, we want users to only see published articles, unless they are an editor, in which case they case see articles with any status. You have to remember to call this method from the view, so I'd suggest reviewing this as part of a security audit checklist.</p>
<h1 id="example-2-policy-for-function-based-view">Example #2: Policy for Function-Based View<a class="headerlink" href="#example-2-policy-for-function-based-view" title="Permanent link">&para;</a></h1>
<p>You can also you policies with function-based views. The action to reference in your policy statements is the name of the function. You can also bundle multiple functions into the same policy as the example below shows.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">AuditLogsAccessPolicy</span><span class="p">(</span><span class="n">AccessPolicy</span><span class="p">):</span>
    <span class="n">statements</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;search_logs&quot;</span><span class="p">],</span>
            <span class="s2">&quot;principal&quot;</span><span class="p">:</span> <span class="s2">&quot;group:it_staff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;effect&quot;</span><span class="p">:</span> <span class="s2">&quot;allow&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;download_logs&quot;</span><span class="p">],</span>
            <span class="s2">&quot;principal&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;group:it_admin&quot;</span><span class="p">],</span>
            <span class="s2">&quot;effect&quot;</span><span class="p">:</span> <span class="s2">&quot;allow&quot;</span>            
        <span class="p">}</span>
    <span class="p">]</span>


<span class="nd">@api_view</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">((</span><span class="n">AuditLogsAccessPolicy</span><span class="p">,))</span>
<span class="k">def</span> <span class="nf">search_logs</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1">## you logic here...</span>
    <span class="k">pass</span>


<span class="nd">@api_view</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">((</span><span class="n">AuditLogsAccessPolicy</span><span class="p">,))</span>
<span class="k">def</span> <span class="nf">download_logs</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1">## you logic here...</span>
    <span class="k">pass</span>
</pre></div>


<h1 id="documentation">Documentation<a class="headerlink" href="#documentation" title="Permanent link">&para;</a></h1>
<h2 id="statement-elements">Statement Elements<a class="headerlink" href="#statement-elements" title="Permanent link">&para;</a></h2>
<h3 id="principal"><em>principal</em><a class="headerlink" href="#principal" title="Permanent link">&para;</a></h3>
<table>
    <tr>
        <td><b>Description</b></td>
        <td>
            Should match the user of the current request by identifying a group they belong to or their user ID.
        </td>
    </tr>
    <tr>
        <td><b>Special Values</b></td>
        <td>
         <code>"*"</code> (any user) <br> 
         <code>"authenticated"</code> (any authenticated user) <br> 
         <code>"anonymous"</code> (any non-authenticated user)
        </td>
    </tr>
    <tr>
        <td><b>Type</b></td>
        <td> <code>Union[str, List[str]]</code> </td>
    </tr>
    <tr>
        <td><b>Format</b></td>
        <td>
             Match by group with <code>"group:{name}"</code> <br> 
             Match by ID with <code>"id:{id}" </code>
        </td>
    </tr>
    <tr>
        <td><b>Examples</b></td>
        <td>
         <code>["group:admins", "id:9322"]</code> <br> 
         <code>["id:5352"]</code> <br> 
         <code>["anonymous"]</code> <br> 
         <code>"*"</code>
        </td>
    </tr>
</table>

<h3 id="action"><em>action</em><a class="headerlink" href="#action" title="Permanent link">&para;</a></h3>
<table>
    <tr>
        <td><b>Description</b></td>
        <td>
         The action or actions that the statement applies to. The value should match the name of a view set method or the name of the view function.
        </td>
    </tr>
    <tr>
        <td><b>Type</b></td>
        <td><code>Union[str, List[str]]</code></td>
    </tr>
    <tr>
        <td><b>Special Values</b></td>
        <td>
            <code>"*"</code> (any action) <br> 
            <code>"&lt;safe_methods&gt;"</code> (a read-only HTTP request: HEAD, GET, OPTIONS)
        </td>
    </tr>
    <tr>
        <td><b>Examples</b></td>
        <td>
            <code>["list", "delete", "create]</code> <br> 
            <code>["*"]</code> <br> 
            <code>["&lt;safe_methods&gt;"]</code>
        </td>
    </tr>
</table>

<h3 id="effect"><em>effect</em><a class="headerlink" href="#effect" title="Permanent link">&para;</a></h3>
<table>
    <tr>
        <td><b>Description</b></td>
        <td>
        Whether the statement, if it is in effect, should allow or deny access. All access is denied by default, so use <code>deny</code> when you'd like to override an <code>allow</code> statement that will also be in effect.
        </td>
    </tr>
    <tr>
        <td><b>Type</b></td>
        <td><code>str</code></td>
    </tr>
    <tr>
        <td><b>Values</b></td>
        <td>Either <code>"allow"</code> or <code>"deny"</code></td>
    </tr>
</table>

<h3 id="condition"><em>condition</em><a class="headerlink" href="#condition" title="Permanent link">&para;</a></h3>
<table>
    <tr>
        <td><b>Description</b></td>
        <td>
        The name of a method on the policy that returns a boolean. The method signature is <code>condition(request, view, action: str, custom_arg: str=None)</code>. If you want to pass a custom argument to the condition's method, format the value as <code>{method_name}:{value}</code>, e.g. <code>user_must_be:owner</code> will call a method named <code>user_must_be</code>, passing it the string <code>"owner"</code> as the final argument. If true, the policy will be in effect. Useful for enforcing object-level permissions. If list of conditions is given, all conditions must evaluate to <code>True</code>.
        </td>
    </tr>
    <tr>
        <td><b>Type</b></td>
        <td><code>Union[str, List[str]]</code></td>
    </tr>
    <tr>
        <td><b>Examples</b></td>
        <td>
            <code>"is_manager_of_account"</code> <br>
            <code>"is_author_of_post"</code> <br>
            <code>["balance_is_positive", "account_is_not_frozen"]`</code>
            <br> 
            <code>"user_must_be:account_manager"</code>
        </td>
    </tr>
</table>

<h2 id="policy-evaluation-logic">Policy Evaluation Logic<a class="headerlink" href="#policy-evaluation-logic" title="Permanent link">&para;</a></h2>
<p>To determine whether access to a request is granted, two steps are applied: (1) finding out which statements apply to the request (2) denying or allowing the request based on those statements. 
- <em>Filtering statements</em>: A statement is applicable to the current request if all of the following are true (a) the request user matches one of the statement's principals, (b) the name of the method/function matches one of its actions, and (c) all custom conditions evaluate to true.
- <em>Allow or deny</em>: The request is allowed if any of the statements have an effect of "allow", and none have an effect of "deny". By default, all requests are denied. Requests are implicitly denied if no <code>Allow</code> statements are found, and they are explicitly denied if any <code>Deny</code> statements are found. <code>Deny</code> statements <em>trump</em> <code>Allow</code> statements.</p>
<h2 id="object-level-permissionscustom-conditions">Object-Level Permissions/Custom Conditions <a id="object-level-perm"> </a><a class="headerlink" href="#object-level-permissionscustom-conditions" title="Permanent link">&para;</a></h2>
<p>What object-level permissions? You can easily check object-level access in a custom condition that's evaluated to determine whether the statement takes effect. This condition is passed the <code>view</code> instance, so you can  get the model instance with a call to <code>view.get_object()</code>. You can even reference multiple conditions, to keep your access methods focused and testable, as well as parametrize these conditions with arguments.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">AccountAccessPolicy</span><span class="p">(</span><span class="n">AccessPolicy</span><span class="p">):</span>
    <span class="n">statements</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1">## ... other statements ...</span>
        <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;withdraw&quot;</span><span class="p">],</span>
            <span class="s2">&quot;principal&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
            <span class="s2">&quot;effect&quot;</span><span class="p">:</span> <span class="s2">&quot;allow&quot;</span><span class="p">,</span>
            <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;balance_is_positive&quot;</span><span class="p">,</span> <span class="s2">&quot;user_must_be:owner&quot;</span><span class="p">]</span>     
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;upgrade_to_gold_status&quot;</span><span class="p">],</span>
            <span class="s2">&quot;principal&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
            <span class="s2">&quot;effect&quot;</span><span class="p">:</span> <span class="s2">&quot;allow&quot;</span><span class="p">,</span>
            <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;user_must_be:account_advisor&quot;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="c1">## ... other statements ...</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">balance_is_positive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">account</span><span class="o">.</span><span class="n">balance</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">user_must_be</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
</pre></div>


<p>Notice how we're re-using the <code>user_must_be</code> method by parameterizing it with the model field that should be equal fo the user of the request: the statement will only be effective if this condition passes.</p>
<h2 id="re-usable-conditionspermissions">Re-Usable Conditions/Permissions <a id="reusable-conditions"> </a><a class="headerlink" href="#re-usable-conditionspermissions" title="Permanent link">&para;</a></h2>
<p>If you'd like to re-use custom conditions across policies, you can define them globally in a module and point to it via the setttings.</p>
<div class="codehilite"><pre><span></span><span class="c1"># in your project settings.py</span>

<span class="n">DRF_ACCESS_POLICY</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;reusable_conditions&quot;</span><span class="p">:</span> <span class="s2">&quot;myproject.global_access_conditions&quot;</span><span class="p">}</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="c1"># in myproject.global_access_conditions.py</span>

<span class="k">def</span> <span class="nf">is_the_weather_nice</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">weather_api</span><span class="o">.</span><span class="n">load_today</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">68</span>

<span class="k">def</span> <span class="nf">user_must_be</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
</pre></div>


<p>The policy class will first check its own methods for what's been defined in the <code>condition</code> property. If nothing is found, it will check the module defined in the <code>reusable_conditions</code> setting.</p>
<h2 id="multitenancy-data-restricting-querysets">Multitenancy Data / Restricting QuerySets<a class="headerlink" href="#multitenancy-data-restricting-querysets" title="Permanent link">&para;</a></h2>
<p>You can define a class method on your policy class that takes a QuerySet and the current request and returns a securely scoped QuerySet representing only the database rows that the current user should have access to. This is helpful for multitenant situations or more generally when users should not have full visibility to model instances. Of course you could do this elsewhere in your code, but putting this method on the policy class keeps all access logic in a single place.</p>
<div class="codehilite"><pre><span></span>    <span class="k">class</span> <span class="nc">PhotoAlbumAccessPolicy</span><span class="p">(</span><span class="n">AccessPolicy</span><span class="p">):</span>
        <span class="c1"># ... statements, etc ...</span>

        <span class="c1"># Users can only access albums they have created</span>
        <span class="nd">@classmethod</span>
        <span class="k">def</span> <span class="nf">scope_queryset</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">qs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">qs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">creator</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>


    <span class="k">class</span> <span class="nc">TodoListAccessPolicy</span><span class="p">(</span><span class="n">AccessPolicy</span><span class="p">):</span>
        <span class="c1"># ... statements, etc ...</span>

        <span class="c1"># Users can only access todo lists owned by their organization</span>
        <span class="nd">@classmethod</span>
        <span class="k">def</span> <span class="nf">scope_queryset</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">qs</span><span class="p">):</span>
            <span class="n">user_orgs</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">organizations</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">qs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">org__id__in</span><span class="o">=</span><span class="n">user_orgs</span><span class="p">)</span>
</pre></div>


<h2 id="attaching-to-viewsets-and-function-based-views">Attaching to ViewSets and Function-Based Views<a class="headerlink" href="#attaching-to-viewsets-and-function-based-views" title="Permanent link">&para;</a></h2>
<p>You attach access policies the same way you do with regular DRF permissions.</p>
<p>For ViewSets, add it to <code>permissions</code> property:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ArticleViewSet</span><span class="p">(</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">ArticleAccessPolicy</span><span class="p">,</span> <span class="p">)</span>
</pre></div>


<p>For function-based views, add it to <code>permissions_classes</code> decorator:</p>
<div class="codehilite"><pre><span></span><span class="nd">@api_view</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">((</span><span class="n">ArticleAccessPolicy</span><span class="p">,))</span>
<span class="k">def</span> <span class="nf">create_article</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1">## you logic here...</span>
    <span class="k">pass</span>
</pre></div>


<h2 id="loading-statements-from-external-source">Loading Statements from External Source<a class="headerlink" href="#loading-statements-from-external-source" title="Permanent link">&para;</a></h2>
<p>If you don't want your policy statements hardcoded into the classes, you can load them from an external data source: a great step to take because you can then change access rules without redeploying code. </p>
<p>Just define a method on your policy class called <code>get_policy_statements</code>, which has the following signature:
<code>get_policy_statements(self, request, view) -&gt; List[dict]</code></p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">UserAccessPolicy</span><span class="p">(</span><span class="n">AccessPolicy</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="s1">&#39;user-policy&#39;</span>

    <span class="k">def</span> <span class="nf">get_policy_statements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="n">statements</span> <span class="o">=</span> <span class="n">data_api</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">statements</span><span class="p">)</span>
</pre></div>


<p>You probably want to only define this method once on your own custom subclass of <code>AccessPolicy</code>, from which all your other access policies inherit.</p>
<h2 id="customizing-user-grouprole-values">Customizing User Group/Role Values<a class="headerlink" href="#customizing-user-grouprole-values" title="Permanent link">&para;</a></h2>
<p>If you aren't using Django's built-in auth app, you may need to define a custom way to retrieve the role/group names to which the user belongs. Just define a method called <code>get_user_group_values</code> on your policy class. It is passed a single argument: the  user of the current request. In the example below, the user model has a to-many relationship with a "roles", which have their "name" value in a field called "title".</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">UserAccessPolicy</span><span class="p">(</span><span class="n">AccessPolicy</span><span class="p">):</span>
    <span class="c1"># ... other properties and methods ...</span>

    <span class="k">def</span> <span class="nf">get_user_group_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">roles</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
</pre></div>


<h2 id="customizing-principal-prefixes">Customizing Principal Prefixes<a class="headerlink" href="#customizing-principal-prefixes" title="Permanent link">&para;</a></h2>
<p>By default, the prefixes to identify the type of principle (user or group) are "id:" and "group:", respectively. You can customize this by setting these properties on your policy class:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">FriendRequestPolicy</span><span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">BasePermission</span><span class="p">):</span>
    <span class="n">group_prefix</span> <span class="o">=</span> <span class="s2">&quot;role:&quot;</span>
    <span class="n">id_prefix</span> <span class="o">=</span> <span class="s2">&quot;staff_id:&quot;</span>

    <span class="c1"># .. the rest of you policy definition ..</span>
</pre></div>


<h1 id="changelog">Changelog <a id="changelog"></a><a class="headerlink" href="#changelog" title="Permanent link">&para;</a></h1>
<h2 id="050-september-2019">0.5.0 (September 2019)<a class="headerlink" href="#050-september-2019" title="Permanent link">&para;</a></h2>
<ul>
<li>Add option to define re-usable custom conditions/permissions in a module that can be referenced by multiple policies.</li>
</ul>
<h2 id="042-june-2019">0.4.2 (June 2019)<a class="headerlink" href="#042-june-2019" title="Permanent link">&para;</a></h2>
<ul>
<li>Fixes readme format for Pypy display.</li>
</ul>
<h2 id="040-june-2019">0.4.0 (June 2019)<a class="headerlink" href="#040-june-2019" title="Permanent link">&para;</a></h2>
<ul>
<li>Allow passing arguments to condition methods, via condition values formatted as <code>{method_name}:{arg_value}</code>.</li>
</ul>
<h2 id="030-may-2019">0.3.0 (May 2019)<a class="headerlink" href="#030-may-2019" title="Permanent link">&para;</a></h2>
<ul>
<li>Adds special <code>&lt;safe_methods&gt;</code> action key that matches when the current request is an HTTP read-only method: HEAD, GET, OPTIONS.</li>
</ul>
<h2 id="020-may-2019">0.2.0 (May 2019)<a class="headerlink" href="#020-may-2019" title="Permanent link">&para;</a></h2>
<ul>
<li>Adds special <code>authenticated</code> and <code>anonymous</code> principal keys to match any authenticated user and any non-authenticated user, respectively. Thanks @bogdandm for discussion/advice!</li>
</ul>
<h2 id="010-may-2019">0.1.0 (May 2019)<a class="headerlink" href="#010-may-2019" title="Permanent link">&para;</a></h2>
<ul>
<li>Initial release</li>
</ul>
<h1 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">&para;</a></h1>
<p>Tests are found in a simplified Django project in the <code>/tests</code> folder. Install the project requirements and do <code>./manage.py test</code> to run them.</p>
<h1 id="license">License<a class="headerlink" href="#license" title="Permanent link">&para;</a></h1>
<p>See <a href="LICENSE.md">License</a>.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"."}})</script>
      
    
  </body>
</html>